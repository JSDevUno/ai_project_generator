<!DOCTYPE html>
<html>
<head>
    <title>Test Browser Streaming</title>
</head>
<body>
    <h1>Test Browser Streaming</h1>
    <button onclick="testStreaming()">Test Streaming Connection</button>
    <div id="output"></div>

    <script>
        async function testStreaming() {
            const output = document.getElementById('output');
            output.innerHTML = '<p>ğŸ§ª Testing streaming connection...</p>';
            
            const testData = {
                projectName: "browser_test",
                instruction: "Create a simple test project",
                plan: `
browser_test/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ main.py
â””â”€â”€ README.md
                `,
                model: "kwaipilot/kat-coder-pro:free",
                sessionId: "browser_test_123"
            };

            try {
                console.log('ğŸ“¡ Making streaming request...');
                output.innerHTML += '<p>ğŸ“¡ Making streaming request...</p>';
                
                const response = await fetch('http://localhost:3002/api/stream/generate-stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });

                console.log('ğŸ“¡ Response status:', response.status);
                output.innerHTML += `<p>ğŸ“¡ Response status: ${response.status}</p>`;

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ Request failed:', errorText);
                    output.innerHTML += `<p>âŒ Request failed: ${errorText}</p>`;
                    return;
                }

                console.log('âœ… Starting to read stream...');
                output.innerHTML += '<p>âœ… Starting to read stream...</p>';

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let messageCount = 0;

                while (true) {
                    const { done, value } = await reader.read();

                    if (done) {
                        console.log('âœ… Stream completed');
                        output.innerHTML += '<p>âœ… Stream completed</p>';
                        break;
                    }

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.trim() && line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                messageCount++;
                                console.log(`ğŸ“¨ Message ${messageCount}:`, data);
                                output.innerHTML += `<p>ğŸ“¨ Message ${messageCount}: ${JSON.stringify(data)}</p>`;
                            } catch (e) {
                                console.warn('Failed to parse:', line);
                                output.innerHTML += `<p>âš ï¸ Failed to parse: ${line}</p>`;
                            }
                        } else if (line.trim()) {
                            console.log('ğŸ“¨ Raw line:', line);
                            output.innerHTML += `<p>ğŸ“¨ Raw line: ${line}</p>`;
                        }
                    }

                    // Safety limit
                    if (messageCount > 10) {
                        console.log('ğŸ›‘ Stopping after 10 messages for testing');
                        output.innerHTML += '<p>ğŸ›‘ Stopping after 10 messages for testing</p>';
                        break;
                    }
                }

                output.innerHTML += `<p>ğŸ‰ Test completed! Received ${messageCount} messages</p>`;

            } catch (error) {
                console.error('ğŸ’¥ Test failed:', error);
                output.innerHTML += `<p>ğŸ’¥ Test failed: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>